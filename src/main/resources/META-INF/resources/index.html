<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Plant monitor dashboard!</title>
    <style>
        h1, h2, h3, h4, h5, h6 {
            margin-bottom: 0.5rem;
            font-weight: 400;
            line-height: 1.5;
        }

        h1 {
            font-size: 2.5rem;
        }

        h2 {
            font-size: 2rem
        }

        h3 {
            font-size: 1.75rem

        }

        h4 {
            font-size: 1.5rem
        }

        h5 {
            font-size: 1.25rem
        }

        h6 {
            font-size: 1rem
        }

        .lead {
            font-weight: 300;
            font-size: 2rem;
        }

        .banner {
            font-size: 2.7rem;
            margin: 0;
            padding: 2rem 1rem;
            background-color: #0d1c2c;
            color: white;
        }

        body {
            margin: 0;
            font-family: -apple-system, system-ui, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
        }

        code {
            font-family: SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            font-size: 87.5%;
            color: #e83e8c;
            word-break: break-word;
        }

        .left-column {
            padding: .75rem;
            max-width: 75%;
            min-width: 55%;
        }

        .right-column {
            padding: .75rem;
            max-width: 25%;
        }

        .container {
            display: flex;
            width: 100%;
        }

        li {
            margin: 0.75rem;
        }

        .right-section {
            margin-left: 1rem;
            padding-left: 0.5rem;
        }

        .right-section h3 {
            padding-top: 0;
            font-weight: 200;
        }

        .right-section ul {
            border-left: 0.3rem solid #71aeef;
            list-style-type: none;
            padding-left: 0;
        }

        .example-code h3 {
            font-weight: 200;
        }

        .row {
            display: flex;
        }

        .row > div {
            padding-right: 2rem;
            flex-grow: 1;
            flex-basis: 0;
        }

        .description {
            padding-left: 2em;
            max-width: 50em;
        }

        #map {
            height: 50vh;
        }

    </style>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.3.2/chart.min.js" integrity="sha512-VCHVc5miKoln972iJPvkQrUYYq7XpxXzvqNfiul1H4aZDwGBGC0lq373KNleaB2LpnC2a/iNfE5zoRYmB4TRDQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
</head>
<body>

<div class="banner lead">
    Plant monitor dashboard
</div>

<div class="container">
    <div class="left-column">

        <h2>Device events</h2>

        <div class="description">
            <p>
                This page shows the events, sent by a plant monitor devices publishing their sensor information.
            </p>
        </div>


        <div class="row">
            <div>
                <h3>Latest message</h3>
                <dl>
                    <dt>Device ID</dt>
                    <dd>
                        <pre><code><span id="device_id">&nbsp;</span></code></pre>
                    </dd>
                    <dt>Timestamp</dt>
                    <dd>
                        <pre><code><span id="timestamp">&nbsp;</span></code></pre>
                    </dd>
                    <dt>Temperature</dt>
                    <dd>
                        <pre><code><span id="temperature">&nbsp;</span>Â°C</code></pre>
                    </dd>
                    <dt>Humidity</dt>
                    <dd>
                        <pre><code><span id="humidity">&nbsp;</span>%</code></pre>
                    </dd>
                    <dt>Soil</dt>
                    <dd>
                        <pre><code><span id="soil">&nbsp;</span></code></pre>
                    </dd>
                </dl>
            </div>
        </div>


        <div>
            <h3>Temperature</h3>
            <div class="row">
                <canvas id="chart_temperature"></canvas>
            </div>
        </div>
        <div>
            <h3>Humidity</h3>
            <div class="row">
            <canvas id="chart_humidity"></canvas>
            </div>
        </div>
        <div>
            <h3>Soil</h3>
            <div class="row">
                <canvas id="chart_soil"></canvas>
            </div>
        </div>

    </div>
</div>
</body>

<script>
    const sensorTypes = ["temperature"]; //, "humidity", "soil"];
    const maxWindow = 7 * 24 * 60 * 60; // Up to a month
    var window = 7 * 24 * 60 * 60; // Default 1 week window for graphs
    var invertedWindow = maxWindow - window;

    var maxDate = new Date();

    // Sensor events for all devices
    var sensorEvents = new Map();

    for (var sensor of sensorTypes) {
        sensorEvents.set(sensor, []);
    }

     // Map of charts present in the DOM
    var charts = {};

    function connect() {
        let proto;
        if (location.protocol === "https:") {
            proto = "wss://";
        } else {
            proto = "ws://";
        }
        console.log("Protocol: ", proto);
        const socket = new WebSocket(proto + location.host + "/ws");
        socket.onopen = function () {
            console.log("Connected to the web socket");
        };
        socket.onclose = function () {
            console.log("Connection lost, trying to re-connect");
            setTimeout(function () {
                connect();
            }, 5000);
        };
        socket.onerror = function () {
            console.log("Connection error, closing socket");
            socket.close();
        };
        socket.onmessage = function (m) {
            console.log("Got message: " + m.data);
            const obj = JSON.parse(m.data);
            console.log("Message: ", obj)
            if (obj.type === "telemetry") {
                const payload = obj.payload;
                document.getElementById("device_id").innerText = payload.deviceId;
                document.getElementById("timestamp").innerText = payload.timestamp;

                for (var sensor of sensorTypes) {
                    document.getElementById(sensor).innerText = payload[sensor];
                    sensorEvents.get(sensor).push({timestamp: new Date(payload.timestamp).getTime() / 1000, value: payload[sensor], deviceId: payload.deviceId});
                }
                updateCharts();
            }
        };
    }
/*
  const humidityChart = function (options, cdata, sensorData) {
    cdata.labels = sensorData.map(function (v) { return new Date(v.timestamp * 1000); });

    cdata.datasets = [];
    for event in sensorData {

    }


      {
        fill: false,
        borderColor: '#fe8b36',
        backgroundColor: '#fe8b36',
        lineTension: 0,
        label: 'Humidity',
        steppedLine: false,
        data: sensorData.filter(function(v) { return v.humidity != null; }).map(function (v) { return v.humidity; }),
      }
    ];

    if (window > 80000) {
      options.elements = {
        point: {
          radius: 0
        }
      };
    }
    options.legend.display = true;
    options.scales.yAxes = [
      {
        ticks: {
          padding: 5,
          display: true,
          beginAtZero: true,
        },
        display: true,
        scaleLabel: {
          display: true,
          labelString: "Humidity (%)"
        }
      }
    ];
  };*/

  // Temperature charts show temperature, potentially with multiple values
  const temperatureChart = function (options, cdata, sensorData) {
    cdata.labels = sensorData.map(function (v) { return new Date(v.timestamp * 1000); });

    var deviceData = new Map();
    for (var event of sensorData) {
        if (deviceData.get(event.deviceId) === undefined) {
            deviceData.set(event.deviceId, []);
        }
        deviceData.get(event.deviceId).push(event.value)
    }

    cdata.datasets = [];
    deviceData.forEach(function (data, device) {
        cdata.datasets.push({
            fill: false,
            borderColor: '#fe8b36',
            backgroundColor: '#fe8b36',
            lineTension: 0,
            label: device,
            steppedLine: false,
            data: data,
        });
    });

    if (window > 80000) {
      options.elements = {
        point: {
          radius: 0
        }
      };
    }
    options.legend.display = true;
    options.scales.yAxes = [
      {
        ticks: {
          padding: 5,
          display: true,
          beginAtZero: true,
        },
        display: true,
        scaleLabel: {
          display: true,
          labelString: "Temperature (Celcius)"
        }
      }
    ];
  };

  // Chart options to reduce duplication between chart types
  const defaultChartOptions = function(min, max) {
    return {
      animation: false,
      legend: {
        display: false
      },
      fill: false,
      responsive: true,
      scales: {
        bounds: 'ticks',
        xAxes: [
          {
            type: 'time',
            display: true,
            distribution: 'linear',
            time: {
              min: new Date(min * 1000),
              max: new Date(max * 1000),
            },
            scaleLabel: {
              display: false,
              labelString: "Date"
            }
          }
        ],
      }
    };
  };

  // Soil charts show soil moisture, potentially with multiple values
  /*
  const soilChart = function (options, cdata, sensorData) {
    cdata.labels = sensorData.map(function (v) { return new Date(v.timestamp * 1000); });

     cdata.datasets = [{
       fill: false,
       borderColor: '#fe8b36',
          backgroundColor: '#fe8b36',
          lineTension: 0,
          label: 'Monitor',
          steppedLine: false,
          data: sensorData,
        }
      ];

      if (window > 80000) {
        options.elements = {
          point: {
            radius: 0
          }
        };
      }
      options.legend.display = true;
      options.scales.yAxes = [
        {
          ticks: {
            padding: 5,
            display: true,
            beginAtZero: false,
            //min: 0,
            //max: 100,
          },
          display: true,
          scaleLabel: {
            display: true,
            labelString: "Soil moisture (%)"
          }
        }
      ];
    }
  };
  */

    const updateChart = function (sensor) {
      const now = Math.floor(Date.now() / 1000);
      //console.log("Window is "+ JSON.stringify(window));
      console.log("Now is : "+ now);
      const since = now - maxWindow;

      const chartName = "chart_" + sensor;
      console.log("Going to update chart " + sensor);
      const element = document.getElementById(chartName);

      if (element != null) {
          // Filter data due to stale watch function
          const sensorData = sensorEvents.get(sensor).filter(function (v) {
              console.log("Comparing "+ since + " to "+ v.timestamp);
              return v.timestamp >= since;
          });
          var options = defaultChartOptions(since, now);
          var cdata = {};

          if (sensor == "humidity") {
            //  humidityChart(options, cdata, sensorData);
          } else if (sensor == "temperature") {
              temperatureChart(options, cdata, sensorData);
          } else if (sensor == "soil") {
            //  soilChart(options, cdata, sensorData);
          }

          if (cdata.datasets !== undefined && cdata.datasets.length > 0) {
              console.log("Cdata (data: " + cdata.datasets[0].data.length + ", labels: " + cdata.labels.length + ": " + JSON.stringify(cdata.datasets[0].data));
          }
          var ctx = element.getContext('2d');
          if (charts[chartName] === undefined) {
              console.log("Creating new chart " + chartName);
              var chart = new Chart(ctx, {
                type: 'line',
                data: cdata,
                options: options
              });
              charts[chartName] = chart;
          } else {
              console.log("Updating chart " + chartName);
              var chart = charts[chartName];
              chart.data = cdata;
              chart.options = options;
              chart.update();
          }
      }

    };

    // Periodically re-render charts to ensure time window is moving
    const updateCharts = function () {
      console.log("UPDATE CHARTS");
      for (var sensor of sensorTypes) {
          console.log("Updating chart for "+ sensor);
          updateChart(sensor);
          /*
          for (var [sensorId, sensorData] of sensors) {
              console.log("Data for " + deviceId + " sensor " + sensorId + ": " + JSON.stringify(sensorData));
          }
          */
      }

      maxDate = new Date();
      setTimeout(updateCharts, 30000);
    };
    setTimeout(updateCharts, 30000);

    const addSeconds = function(existing, seconds) {
      var dt = new Date(existing);
      dt.setSeconds(dt.getSeconds() + seconds);
      return dt;
    };

    var dateSince = addSeconds(maxDate, -window).toString();
    const rangeUpdated = function() {
      window = maxWindow - invertedWindow;
      updateCharts();
      dateSince = addSeconds(maxDate, -window).toString();
    };

    connect();

</script>

</html>